# AGENTS.md

このファイルは、`/Users/yamaguchi_yoshito/Downloads/React/test-guide` で作業するエージェント向けの実務ルールです。

## 1. 基本方針

- 回答は日本語で行う。
- 抽象論ではなく、再現可能な手順と客観情報を優先する。
- 変更は最小差分で行い、既存設計（API層分離・テスト運用）を壊さない。
- 思考は英語で行い、出力は常に日本語の Markdown 構造で返す。
- 不明点がある場合は「不明」と断定せず、既知情報から合理的に推定して提案する。
- 結論を先に述べ、曖昧語（「適宜」「いい感じに」「必要に応じて」）は使わない。

## 1.1 出力フォーマット規約

- 変更報告には必ず以下を含める:
  - 変更ファイルの絶対パス
  - 実行コマンド
  - 検証結果（成功/失敗）
- コード修正時は、目的・変更内容・影響範囲を分離して記載する。
- コードレビュー時は、要約より先に問題点を優先度順に列挙する。

## 2. 作業対象の優先順位

1. `apps/web`（Next.js サンプル実装）
2. `packages/test-utils`（共有テストユーティリティ）
3. `docs`（運用ガイド）

## 3. 主要コマンド

作業ディレクトリ: `apps/web`

```bash
pnpm run type-check
pnpm run test:unit
pnpm run test:e2e
pnpm run openapi:check
```

補足:
- 失敗時は標準エラーの要点をそのまま報告する。
- 実行していないコマンドは「未実行」と明記する。

## 4. 変更時の必須確認

- API通信は `src/api/core/httpClient.ts` 経由で統一する。
- ドメイン通信は `src/api/clients/*Client.ts`、UI は `src/api/hooks/*` 経由で利用する。
- コンポーネントから `fetch/axios` を直接呼ばない。
- ログは `src/api/core/logger.ts` を使い、PII（email/token/password 等）を平文出力しない。

## 5. ログ実装ルール

- 相関IDは `X-Correlation-ID` を使用する。
- API Route は `src/app/api/_lib/requestId.ts` の `resolveRequestId()` を使う。
- イベント名は `apps/web/docs/logging-guide.md` の一覧に合わせる。
- レベル制御は `LOG_LEVEL`（server）と `NEXT_PUBLIC_LOG_LEVEL`（client）を使う。

## 6. OpenAPI 運用

- 仕様の正本は `apps/web/openapi.yaml`。
- 分割ファイルは `apps/web/openapi/paths/*` と `apps/web/openapi/components/*`。
- 生成コード直接編集は禁止。必要な変更は OpenAPI 定義か `orval.config.ts` 側で行う。

## 7. テストと品質

- 仕様変更・バグ修正時は、最低1件の自動テストを追加または更新する。
- 変更完了時は `type-check` と `test:unit` を必ず実行し、結果を報告する。
- 実行不可の確認項目がある場合は、理由を明示する。

## 8. ドキュメント更新

- 実装ルールを変えた場合は、`README.md` または `docs/README.md` の索引を更新する。
- ログ仕様変更時は `apps/web/docs/logging-guide.md` を更新する。

## 9. 禁止事項

- 無関係なファイルのリファクタを混ぜない。
- 生成物（`src/generated/*`）を手編集しない。
- 失敗したコマンド結果を隠さない。
- 一般論だけで回答を終わらせない。
- 実行可能な手順を示さずに提案だけを出さない。

## 10. 作業モード

### 10.1 レビュー専用モード

トリガー:
- ユーザーが「review」「レビュー」「コードレビュー」と要求した場合。

動作:
- 目的は不具合・リスク・仕様逸脱の検出を最優先とする。
- 指摘は重大度順（`P0 > P1 > P2 > P3`）で列挙する。
- 各指摘は「事実」「影響」「修正案」を1セットで示す。
- ファイルパスと行番号を必ず添える。
- 指摘が0件の場合は「問題なし」を明記し、残留リスクを記載する。

出力テンプレート:
- `Findings`
- `Open Questions / Assumptions`
- `Change Summary`（必要時のみ）

### 10.2 実装専用モード

トリガー:
- ユーザーが「実装して」「fixして」「go」「進めて」と要求した場合。

動作:
- 仕様確認より実装を優先し、未確定事項は合理的な既定値で前進する。
- 変更は最小差分で行い、関連テストを同時更新する。
- 変更後に `type-check` と `test:unit` を実行して結果を提示する。
- 失敗時は止まらず、原因と次の一手を提示する。

出力テンプレート:
- `目的`
- `変更内容`
- `影響範囲`
- `実行コマンド`
- `検証結果`
- `未対応/次アクション`（存在する場合のみ）

### 10.3 デフォルト動作

- ユーザー入力が短文（例: `ok go`）の場合は、直前合意された計画を実装専用モードで継続実行する。
